<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #START {
      position: absolute;
      left: 15px;
      top: 100px;
    }
    #RETRY {
      position: absolute;
      left: 45px;
      top: 200px;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id = "can"></canvas>
  <img id="START" src="start.png" onclick="startGame()"><br/>
  <img id="RETRY" src="retry02.png" onclick="startGame()"><br/>
  <!-- <img id="BGIMG" src="bgimage.jpeg" onclick="startGame()"><br/> -->

  <script>

    //`音量設定
    let soundVolume = 0.5;

    //落ちるスピード
    let cycleCount = 0;
    let cycleCountMax = 100; 
    let GAME_SPEED = 5;

    //フィールドサイズ
    const FIELD_COL = 10;
    const FIELD_ROW = 20;

    //ブロック１つのサイズ（ピクセル）
    const BLOCK_SIZE = 20;

    //キャンバスサイズ
    const SCREEN_W = BLOCK_SIZE * FIELD_COL;
    const SCREEN_H = BLOCK_SIZE * FIELD_ROW;

    //テトロミノのサイズ
    const TETRO_SIZE = 4;

    let can = document.getElementById("can");
    let con = can.getContext("2d");

    can.onmousedown = mymousedown;
    can.onmouseup = mymouseup;
    // maze.oncontextmenu = function (e) { e.preventDefault(); };
    can.addEventListener('touchstart', mymousedown);
    can.addEventListener('touchend', mymouseup);
    document.getElementById("START").style.display=("block");

    can.width        = SCREEN_W+120;
    can.height       = SCREEN_H+120;
    can.style.border = "4px solid #555";
    con.font = "bold 20px MS ゴシック";

    const TETRO_COLORS = [
      "#000",     // 0空
      "#6CF",     // 1水色
      "#FB2",     // 2オレンジ
      "#66F",     // 3青
      "#C5C",     // 4紫
      "#FD2",     // 5黄色
      "#F44",     // 6赤
      "#5B5",     // 7緑
    ];

    // テトロミノ本体
    const TETRO_TYPES = [
      [], // 0.空っぽ
      [                 // 1.I
        [ 0, 0, 0, 0 ],
        [ 1, 1, 1, 1 ],
        [ 0, 0, 0, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 2.L
        [ 0, 1, 0, 0 ],
        [ 0, 1, 0, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 3.J
        [ 0, 0, 1, 0 ],
        [ 0, 0, 1, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 4.T
        [ 0, 1, 0, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 1, 0, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 5.O
        [ 0, 0, 0, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 6.Z
        [ 0, 0, 0, 0 ],
        [ 1, 1, 0, 0 ],
        [ 0, 1, 1, 0 ],
        [ 0, 0, 0, 0 ]
      ],
      [                 // 7.S
        [ 0, 0, 0, 0 ],
        [ 0, 1, 1, 0 ],
        [ 1, 1, 0, 0 ],
        [ 0, 0, 0, 0 ]
      ]
    ];

    //画像と効果音
    let bgimage;
    bgimage = new Image();
    bgimage.src = "bgimage.jpeg";
    let blImage; 
    blImage = new Image();
    blImage.src = "blocks2.png";
    let se1,se2,se3;
    se1 = new Audio("se1.wav");
    se2 = new Audio("se2.wav");
    se3 = new Audio("se3.wav");

    se1.volume = soundVolume;
    se2.volume = soundVolume;
    se3.volume = soundVolume;

    //初期位置
    const START_X = FIELD_COL/2 - TETRO_SIZE/2;
    const START_Y = 0;

    // テトロミノ本体
    let tetro;
    //テトロミノの座標
    let tetro_x = START_X;
    let tetro_y = START_Y;
    //テトロミノの形
    let tetro_t;
    //テトロミノネクスト
    let tetro_n;
    //フィールドの中身
    let field = [];

    let start = false;
    //ゲームオーバーフラグ
    let over = false;
    //消したライン数
    let lines = 0;
    //スコア
    let score = 0;
    let speed = 0;

    let countx = 0;
    let keyCode2 = 0;

    //ゲームフィールドの位置
    const OFFSET_X = 10;//(640-300)/2;
    const OFFSET_Y = 10;
    
    // function play() {
    //   console.log("IN :",iv_id)
    //   if(iv_id) {
    //     clearInterval(iv_id);
    //   }
    //   clearInterval(iv_id);
    //   console.log("MID:",iv_id);
    //   iv_id = setInterval(dropTetro,GAME_SPEED-speed);
    //   console.log("OUT:",iv_id)

    // }



    //イニシャライズでスタート
    function startGame(){
      init();
      document.getElementById("START").style.display=("none");
      document.getElementById("RETRY").style.display=("none");
      start = true;
      over = false;
      speed = 0;
      // play();
      setInterval(dropTetro,GAME_SPEED);
      // clearInterval(gs);
      // setInterval( gs, GAME_SPEED);
      // console.log( "aaa: "+gs );
    }
    
    init()
    
    //初期化
    function init()
    {
      speed = 0;
      for (let y = 0; y < FIELD_ROW; y++)
      {
        field[y] = [];
        for (let x = 0; x < FIELD_COL; x++)
        {
          field[y][x] = 0;
        }
      }

      //最初のテトロのためネクストに入れる
      tetro_n = Math.floor( Math.random()*(TETRO_TYPES.length-1))+1;
      tetro_n = 5;

      //テトロをセットして描画して開始！
      setTetro();
      drawAll();
   

      // if(start){
      //   setInterval( dropTetro, GAME_SPEED-speed);
      //   console.log("yesyesyes");
      //   countx++;
      // }
      // let keyCode2 = 0;
    }

    //テトロをネクストで初期化
    function setTetro()
    {
      //ネクストを現在のテトロにする
      tetro_t = tetro_n;
      tetro = TETRO_TYPES[tetro_t];
      // tetro_n = Math.floor( Math.random()*(TETRO_TYPES.length-1))+1;
      tetro_n = 5;

      //位置を初期値にする
      tetro_x = START_X;
      tetro_y = START_Y;
    }

    //ブロック１つを描画する
    function drawBlock(x,y,c)
    {
      let px = OFFSET_X + x * BLOCK_SIZE;
      let py = OFFSET_Y + y * BLOCK_SIZE;

      con.drawImage(blImage,
        c*BLOCK_SIZE,0, BLOCK_SIZE,BLOCK_SIZE,
        px,py,          BLOCK_SIZE,BLOCK_SIZE);
    }

    function drawBack(){
      con.drawImage(bgimage,-20,0,350,580);
      //フィールドの枠を描く
      con.strokeStyle="rgba(80,160,255,0.1)";
      con.strokeRect(OFFSET_X-6,OFFSET_Y-6,SCREEN_W+12,SCREEN_H+12);
      con.strokeStyle="rgba(80,160,255,0.5)";
      con.strokeRect(OFFSET_X-2,OFFSET_Y-2,SCREEN_W+4,SCREEN_H+4);
      con.fillStyle="rgba(0,0,0,0.4)";
      con.fillRect(OFFSET_X,OFFSET_Y,SCREEN_W,SCREEN_H);

      drawCircle(40, 470, 35,"lightgreen");
      drawCircle(165, 470, 35,"lightgreen");
      drawCircle(280, 470, 35,"lightgreen");
      drawCircle(280, 350, 35,"lightgreen");
    }

    //全部描画する
    function drawAll()
    {
      drawBack();
      //背景を描画
      // con.drawImage(bgimage,0,0,800,1200);
      // //フィールドの枠を描く
      // con.strokeStyle="rgba(80,160,255,0.1)";
      // con.strokeRect(OFFSET_X-6,OFFSET_Y-6,SCREEN_W+12,SCREEN_H+12);
      // con.strokeStyle="rgba(80,160,255,0.5)";
      // con.strokeRect(OFFSET_X-2,OFFSET_Y-2,SCREEN_W+4,SCREEN_H+4);
      // con.fillStyle="rgba(0,0,0,0.4)";
      // con.fillRect(OFFSET_X,OFFSET_Y,SCREEN_W,SCREEN_H);

      //フィールドを描画
      for (let y = 0; y < FIELD_ROW; y++)
      {
        for (let x = 0; x < FIELD_COL; x++)
        {
          if (field[y][x])
          {
            drawBlock(x,y, field[y][x]);
          }
        }
      }

      // drawCircle(40, 470, 35,"lightgreen");
      // drawCircle(165, 470, 35,"lightgreen");
      // drawCircle(280, 470, 35,"lightgreen");
      // drawCircle(280, 350, 35,"lightgreen");


      //着地点を計算
      let plus=0;
      while( checkMove(0,plus+1))plus++;

      //テトロミノを描画
      for (let y = 0; y < TETRO_SIZE; y++)
      {
        for (let x = 0; x < TETRO_SIZE; x++)
        {
          //テトロ本体
          if (tetro[y][x])
          {
            //着地点
            drawBlock(tetro_x+x, tetro_y+y+plus, 0);
            //本体
            drawBlock(tetro_x+x, tetro_y+y,      tetro_t);
          }
          //ネクストテトロ
          if( TETRO_TYPES[tetro_n][y][x] )
          {
            drawBlock(11+x, 3+y, tetro_n);
          }
        }
      }

      drawInfo();
    }

    //インフォメーション表示
    function drawInfo()
    {
      let w;
      con.fillStyle="darkblue";

      let s="NEXT";
      con.fillText(s,230,65);

      s="SCORE";
      con.fillText(s,230,160);
      s=""+score;
      w = con.measureText(s).width;
      con.fillText(s, 300-w, 180);

      s="LINES";
      w = con.measureText(s).width;
      con.fillText(s,230,210);
      s=""+lines;
      w = con.measureText(s).width;
      con.fillText(s, 300-w, 230);

      s="speed";
      w = con.measureText(s).width;
      con.fillText(s,230,260);
      s=""+cycleCountMax;
      w = con.measureText(s).width;
      con.fillText(s, 300-w, 280);

      con.fillText("<<",28,465);
      con.fillText("Left",18,485);

      con.fillText(">>",270,465);
      con.fillText("Right",250,485);

      con.fillText("◎",155,465);
      con.fillText("Turn",140,485);

      con.fillText("▽",270,345);
      con.fillText("Drop",252,365);

      if (over)
      {   
        s ="GAME OVER";
        w = con.measureText(s).width;
        let x = SCREEN_W/2 - w/2;
        let y = SCREEN_H/2 - 40;
        con.lineWidth = 4;
        con.strokeText(s,OFFSET_X+x,y);
        con.fillStyle="white";
        con.fillText(s,OFFSET_X+x,y); 
        // con.font = "40px MS ゴシック";
        // let w = con.measureText(s).width;
        GAME_SPEED = 500;
        cycleCountMax = 100;
        clearInterval(dropTetro);
        document.getElementById("RETRY").style.display=("block");
        // init();
        console.log("end");
      }
    }

    //ブロックの衝突判定
    function checkMove( mx, my, ntetro)
    {
      if ( ntetro == undefined ) ntetro = tetro;

      for (let y = 0; y < TETRO_SIZE; y++)
      {
        for (let x = 0; x < TETRO_SIZE; x++)
        {
          if ( ntetro[y][x] )
          {
            let nx = tetro_x + mx + x;
            let ny = tetro_y + my + y;
            if ( ny < 0 ||
                 nx < 0 ||
                 ny >= FIELD_ROW ||
                 nx >= FIELD_COL ||
                 field[ny][nx] )
            {
              return false;
            }
          }
        }
      }
      return true;
    }

    //テトロの回転
    function rotate()
    {
      let ntetro = [];

      for (let y = 0; y < TETRO_SIZE; y++)
      {
        ntetro[y] =[];
        for (let x = 0; x < TETRO_SIZE; x++)
        {
          ntetro[y][x] = tetro[TETRO_SIZE-x-1][y];
        }
      }
      return ntetro;
    }

    //テトロを固定する
    function fixTetro()
    {

      for (let y = 0; y < TETRO_SIZE; y++)
      {
        for (let x = 0; x < TETRO_SIZE; x++)
        {
          if ( tetro[y][x] )
          {
            field[tetro_y + y][tetro_x + x] = tetro_t;
          }
        }
      }
    }
    
    //ラインが揃ったかチェックして消す
    function checkLine()
    {
      let linec = 0;
      for (let y = 0; y < FIELD_ROW; y++)
      {
        let flag = true;
        for (let x = 0; x < FIELD_COL; x++)
        {
          if( !field[y][x])
          {
            flag = false;
            break;
          }
        }
        if(flag)
        {
          linec++;
          for(let ny = y; ny>0; ny--)
          {
            for(let nx=0;nx<FIELD_COL ; nx++)
            {
              field[ny][nx] = field[ny-1][nx];
            }
          }
        }
      }

      if(linec)
      {
        se3.pause();
        se3.play();
        lines +=   linec;
        score+=100* (2**(linec-1));
        // clearInterval( dropTetro);
        // if(speed<GAME_SPEED-10)speed+=10;
        if(cycleCountMax >= 10)cycleCountMax-=10;
        // speed+=1000;
        // setInterval( dropTetro, GAME_SPEED+speed);
        // setInterval( dropTetro, 300);
        // play();
        // console.log(iv_id);
      }
    }

    //ブロックの落ちる処理
    function dropTetro()
      {
      cycleCount += 1;
      if (cycleCount < cycleCountMax ) {
        return;
      }
      cycleCount = 0;
    
      if (over) return;

      if ( checkMove(  0,  1 ))tetro_y++;
      else
      {
        se1.play();
        fixTetro();
        checkLine();
        setTetro();
        // tetro_t = Math.floor( Math.random()*(TETRO_TYPES.length-1))+1;
        // tetro = TETRO_TYPES[tetro_t];
        // tetro_x = START_X;
        // tetro_y = START_Y;
        if ( !checkMove(0,0) )over=true;
      }
      drawAll();
    }

    function controle()
    {
      switch(keyCode2)
      {
        case 37:// 左
            if ( checkMove( -1,  0 ))tetro_x--;
            break;
        case 38:// 上
            //if ( checkMove(  0, -1 ))tetro_y--;
            break;
        case 39:// 右
            if ( checkMove(  1,  0 ))tetro_x++;
            break;
        case 40:// 下
            while( checkMove(0,  1 ))tetro_y++;
            break;
        case 32:// スペース
            let ntetro = rotate();
            if ( checkMove( 0, 0, ntetro))
            {
              se2.pause();
              se2.play();
              tetro = ntetro;
            }
            break;
        }
        drawAll();
    }

    //キーボードが押された時の処理
    document.onkeydown = function(e)
    {
      if (over) return;
      keyCode2 = e.keyCode;
      controle();
    }


    function mymouseup(e){
      keyCode2 = 0;
      // ship.keyL = false;
      // ship.keyR = false;
      // ship.keyH = false;
    } 

    function mymousedown(e) {
        e.preventDefault() ;
        var mouseX = !isNaN(e.offsetX) ? e.offsetX : e.touches[0].clientX;
        var mouseY = !isNaN(e.offsetY) ? e.offsetY : e.touches[0].clientY;
        if (mouseX < 80 && 420 < mouseY) {
          keyCode2 = 37;
            } else {
              if(240 < mouseX && 420 < mouseY && 420 < mouseY) {
                keyCode2 = 39;
              } else {
                if (250 < mouseX && 400 > mouseY ) {
                  keyCode2 = 40;
                } else {
                  if (110 < mouseX && mouseX < 220 && 420 < mouseY ) {
                    keyCode2 = 32;
                  }
                }
              }
            }
        controle();
        drawCircle(mouseX, mouseY, 35,"red");
    }

    function drawCircle(x, y, r, color){
    con.fillStyle = color;
    con.beginPath();
    con.arc(x, y, r, 0, Math.PI*2);
    con.fill();
}

    
  </script>
</body>
</html>